# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: Deploy Service Tool

on:
  push:
    branches:
      - production

env:
  IMAGE_TAG: ${{ github.sha }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  deploy:
    runs-on: [self-hosted]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create backend .env
        run: |
          cat <<EOF > backend/.env
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          EOF

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build backend image
        run: |
          docker build \
            --file backend/Dockerfile \
            --tag $DOCKERHUB_USERNAME/service-tool-backend:$IMAGE_TAG \
            .

      - name: Build frontend image
        run: |
          docker build \
            --file Dockerfile.frontend \
            --build-arg VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --build-arg VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }} \
            --tag $DOCKERHUB_USERNAME/service-tool-frontend:$IMAGE_TAG \
            .

      - name: Push backend image
        run: docker push $DOCKERHUB_USERNAME/service-tool-backend:$IMAGE_TAG

      - name: Push frontend image
        run: docker push $DOCKERHUB_USERNAME/service-tool-frontend:$IMAGE_TAG

      - name: Deploy stack with docker-compose
        run: |
          docker-compose pull
          docker-compose up -d

      - name: Health check backend
        run: |
          sleep 10
          curl -f http://localhost/api/ || (echo "Backend health check failed" && exit 1)

      - name: Health check frontend
        run: |
          sleep 10
          curl -f http://localhost/ || (echo "Frontend health check failed" && exit 1)

      - name: Deploy to GitHub Pages
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: Install dependencies
        run: npm ci
        
      - name: Build for GitHub Pages
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
          
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
